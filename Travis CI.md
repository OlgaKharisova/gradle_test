## Непрерывная интеграция

Непрерывная интеграции в проекте обеспечивается сервисом [Travis CI](https://travis-ci.org/).
Для этого репозиторий на гитхабе добавлен в данный сервис. Это делается в админке на сайте Travis CI.
Также в проект добавлен файл [.travis.yml](https://github.com/aliskhakov/stc-9-sun/blob/develop/.travis.yml) в корне проекта, в котором описывается сценарий сборки проекта.
Сейчас настроено так, что при попадании коммитов в ветки `master`, `develop`, а также в случае пулл реквестов происходит
сборка проекта. Описание сборки Java проекта есть в [документации](https://docs.travis-ci.com/user/languages/java/).
В проекте выполняются следующие команды:

```
script:
  - ./gradlew assemble
  - ./gradlew check
  ...
```

После сборки сканируется исходный код при помощи сервиса [Sonar Cloud](https://sonarcloud.io/).
Для этого в сценарий сборки добавлен плагин Сонара:

```
...
addons:
  sonarcloud:
    organization: $SONARCLOUD_ORGANIZATION
    token:
      secure: $SONARCLOUD_TOKEN
...
```

А также добавлены команды для сканнера:

```
script:
  ...
  - sonar-scanner
  - rm -rf .scannerwork
```

Настройки проекта для сонар клауда находятся в файле `sonar-project.properties` в корне проекта. Описание для настройки сонара для тревиса [тут](https://docs.travis-ci.com/user/sonarcloud/)).

Тут стоит отметить, что первое сканирование нужно проводить локально на
своем рабочем компьютере, иначе сонар клауд не будет работать. Перед этим нужно зарегистрироваться
в сонар клауде, создать организацию для проектов и сгенерировать токен.
Сканирование можно провести используя [гредл](https://about.sonarcloud.io/get-started/), для этого нужно поставить плагин для сонара. Также можно
скачать сканнер и без греддла это сделать. При запуске сканера нужно указать реквизиты доступа к проекту на сонар клауде.

После сборки и сканирования происходит деплой на хостинг [Heroku](https://heroku.com). Есть возможность использовать этот хостинг бесплатно в ограниченном объеме.
Есть несколько способов интегрировать хероку с гитхабом. Можно например в
админке хероку указать репозиторий на гитхабе и хероку сам его подтянет.
Но я решил сделать чтоб именно CI это сделал только после успешной сборки. У тревиса есть [описание](https://docs.travis-ci.com/user/deployment/heroku/), как это сделать.
Вот мой кусок сценария деплоя, описанный в `.travis.yml` в корне проекта:

```
deploy:
  provider: heroku
  api_key:
    secure: $HEROKU_API_KEY
  app:
    develop: $HEROKU_DEVELOP_APP
  on:
    all_branches: true
```

Все секретные данные, можно задать в админке тревиса в виде переменных окружения и использовать в сценарии.
В хероку тоже есть возможность задать переменные окружения, которые будут использоваться в проекте.
В нашем случае в хероку заданы реквизиты доступа к постгресу, который находится в другом сервисе.
Саму бд можно было и на хероку поднять, но мы уже юзали чторонний сервис. Процесс деплоя гредл проекта описан в [документации](https://devcenter.heroku.com/articles/deploying-gradle-apps-on-heroku).
Из ключевого: нужно добавить в проект `Procfile` и таск `stage` в файле `build.gradle`.

```
task stage() {
    dependsOn clean, war
}
war.mustRunAfter clean

task copyToLib(type: Copy) {
    into "$buildDir/server"
    from(configurations.compile) {
        include "webapp-runner*"
    }
}
stage.dependsOn(copyToLib)
```

Также следует сказать, что в греддле нужно добавить аппликейшн сервер.

```
compile group: 'com.github.jsimone', name: 'webapp-runner', version: '8.5.11.3'
```


Это как раз описано в `Procfile`:

```
web: java $JAVA_OPTS -Dspring.profiles.active=prod -jar build/server/webapp-runner-*.jar --port $PORT build/libs/*.war
```

Его хероку использует для запуска java проектов.

Еще забыл указать, что тревису нужен gradle-wrapper.jar, поэтому папку gradle нужно убрать из гитигнора.
